<?xml version="1.0" encoding="UTF-8"?>
<entities xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/entity-definition-3.xsd">
    <!--
      Created a view to fetch eligible orders for creating an order feed from HotWax to NetSuite.
      The view consolidates relevant data from `OrderHeader`, `OrderIdentification`, and `PartyIdentification` entities.

        Criteria for fetching eligible records:
        1. The order must be of type `SALES_ORDER`
        2. The order should not already sync with Netsuite
        3. The customer should be synced with Netsuite
        4. A date filter can be applied in `OrderIdentification` to fetch the eligible identification.
    -->
    <view-entity entity-name="EligibleOrdersForNetSuiteView" package="co.hotwax.order">
        <member-entity entity-alias="OH" entity-name="org.apache.ofbiz.order.order.OrderHeader"/>
        <member-entity entity-alias="OID" entity-name="co.hotwax.order.OrderIdentification" join-from-alias="OH" join-optional="true">
            <key-map field-name="orderId"/>
            <entity-condition>
                <econdition entity-alias="OID" field-name="orderIdentificationTypeId" value="NETSUITE_ORDER_ID"/>
                <date-filter/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="ODR" entity-name="org.apache.ofbiz.order.order.OrderRole" join-from-alias="OH" join-optional="true">
            <key-map field-name="orderId"/>
            <entity-condition>
                <econdition entity-alias="ODR" field-name="roleTypeId" operator="equals" value="BILL_TO_CUSTOMER"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="PID" entity-name="org.apache.ofbiz.party.party.PartyIdentification" join-from-alias="ODR">
            <key-map field-name="partyId"/>
            <entity-condition>
                <econdition entity-alias="PID" field-name="partyIdentificationTypeId" value="NETSUITE_CUSTOMER_ID"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="OIASG" entity-name="co.hotwax.order.OrderItemAndShipGroup" sub-select="non-lateral" join-optional="true" join-from-alias="OH">
            <key-map field-name="orderId"/>
            <entity-condition>
                <econdition entity-alias="OIASG" field-name="shipmentMethodTypeId" operator="not-equals" value="POS_COMPLETED"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="INVORD" entity-name="co.hotwax.netsuite.order.InvalidOrdersForNetsuite" sub-select="non-lateral" join-from-alias="OH" join-optional="true">
            <key-map field-name="orderId"/>
        </member-entity>
        <member-entity entity-alias="SCENM" entity-name="moqui.basic.Enumeration" join-from-alias="OH" join-optional="true">
            <key-map field-name="salesChannelEnumId" related="enumId"/>
        </member-entity>
        <entity-condition>
            <econdition entity-alias="OH" field-name="orderTypeId" operator="equals" value="SALES_ORDER"/>
            <econdition entity-alias="OID" field-name="orderId" operator="equals" value=""/>
            <econdition entity-alias="INVORD" field-name="orderId" operator="equals" value=""/>
        </entity-condition>
        <alias name="partyId" entity-alias="PID"/>
        <alias name="netsuiteCustomerId" entity-alias="PID" field="idValue"/>
        <alias entity-alias="SCENM" field="enumCode" name="orderSalesChannelCode"/>
        <alias entity-alias="SCENM" field="description" name="orderSalesChannelDescription"/>
        <alias-all entity-alias="OH"/>
        <alias entity-alias="OIASG" field="orderItemSeqId" name="nonPosCompletedItemsCount" function="count"/>
    </view-entity>
    <view-entity entity-name="InvalidOrdersForNetsuite" package="co.hotwax.netsuite.order">
        <member-entity entity-alias="OH" entity-name="org.apache.ofbiz.order.order.OrderHeader"/>
        <member-entity entity-alias="OI" entity-name="org.apache.ofbiz.order.order.OrderItem" join-from-alias="OH">
            <key-map field-name="orderId"/>
        </member-entity>
        <member-entity entity-alias="GID" entity-name="org.apache.ofbiz.product.product.GoodIdentification" join-from-alias="OI" join-optional="true">
            <key-map field-name="productId"/>
            <entity-condition>
                <econdition field-name="goodIdentificationTypeId" value="NETSUITE_PRODUCT_ID"/>
                <date-filter/>
            </entity-condition>
        </member-entity>
        <alias-all entity-alias="OH"/>
        <alias name="productId" entity-alias="OI" field="productId"/>
        <entity-condition>
            <econdition field-name="goodIdentificationTypeId" entity-alias="GID" operator="equals" value="null"/>
            <econdition field-name="orderTypeId" entity-alias="OH" operator="equals" value="SALES_ORDER"/>
        </entity-condition>
    </view-entity>
    <view-entity entity-name="CustomerDepositSyncView"  package="co.hotwax.financial">
        <member-entity entity-alias="OH" entity-name="org.apache.ofbiz.order.order.OrderHeader"/>
        <member-entity entity-alias="OID" entity-name="co.hotwax.order.OrderIdentification" join-from-alias="OH">
            <key-map field-name="orderId"/>
            <entity-condition>
                <econdition entity-alias="OID" field-name="orderIdentificationTypeId" value="NETSUITE_ORDER_ID"/>
                <date-filter/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="OPP" entity-name="org.apache.ofbiz.order.order.OrderPaymentPreference" join-from-alias="OH">
            <key-map field-name="orderId"/>
        </member-entity>
        <member-entity entity-alias="OISG" entity-name="org.apache.ofbiz.order.order.OrderItemShipGroup" join-from-alias="OH">
            <key-map field-name="orderId"/>
        </member-entity>
        <member-entity entity-alias="OS" entity-name="org.apache.ofbiz.order.order.OrderStatus" join-from-alias="OH" join-optional="true">
            <key-map field-name="orderId"/>
            <entity-condition>
                <econdition field-name="orderItemSeqId" operator="is-null" entity-alias="OS"/>
                <econdition field-name="orderPaymentPreferenceId" operator="is-null" entity-alias="OS"/>
            </entity-condition>
        </member-entity>
        <alias name="shopifyOrderNo" field="externalId" entity-alias="OH"/>
        <alias name="totalAmount" field="maxAmount" entity-alias="OPP"/>
        <alias name="externalId" field="manualRefNum" entity-alias="OPP"/>
        <alias name="fromDate" entity-alias="OID"/>
        <alias name="orderId" field="idValue" entity-alias="OID"/>
        <alias name="paymentMethodTypeId" entity-alias="OPP"/>
        <alias name="orderPaymentPreferenceId" entity-alias="OPP"/>
        <alias name="shipmentMethodTypeId" entity-alias="OISG" is-aggregate="true"/>
        <alias name="statusCount" field="statusId" entity-alias="OS" function="count"/>
        <alias name="status" field="statusId" entity-alias="OS" function="max"/>
        <alias name="hotwaxOrderId" field="orderId" entity-alias="OH"/>
        <entity-condition>
            <econdition entity-alias="OH" field-name="orderTypeId" value="SALES_ORDER"/>
            <econdition field-name="statusId" operator="not-equals" value="PAYMENT_REFUNDED" entity-alias="OPP"/>
            <having-econditions combine="or">
                <econditions>
                    <econdition field-name="statusCount" operator="equals" value="1"/>
                    <econdition field-name="status" operator="not-equals" value="ORDER_CANCELLED"/>
                </econditions>
                <econdition field-name="statusCount" operator="greater" value="1"/>
            </having-econditions>
        </entity-condition>
    </view-entity>
    <view-entity entity-name="CustomerView"  package="co.netsuite.customer">
        <member-entity entity-alias="PER" entity-name="org.apache.ofbiz.party.party.Person"/>
        <member-entity entity-alias="PROLE" entity-name="org.apache.ofbiz.party.party.PartyRole" join-from-alias="PER">
            <key-map field-name="partyId"/>
        </member-entity>
        <member-entity entity-alias="PTY" entity-name="org.apache.ofbiz.party.party.Party" join-from-alias="PER">
            <key-map field-name="partyId"/>
        </member-entity>
        <member-entity entity-alias="NSPID" entity-name="org.apache.ofbiz.party.party.PartyIdentification" join-from-alias="PTY" join-optional="true">
            <key-map field-name="partyId"/>
            <entity-condition>
                <econdition field-name="partyIdentificationTypeId" operator="equals" value="NETSUITE_CUSTOMER_ID"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="PID" entity-name="org.apache.ofbiz.party.party.PartyIdentification" join-from-alias="PTY">
            <key-map field-name="partyId"/>
            <entity-condition>
                <econdition field-name="partyIdentificationTypeId" operator="equals" value="SHOPIFY_CUST_ID"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="PCONTECH" entity-name="org.apache.ofbiz.party.contact.PartyContactMech" join-from-alias="PTY" join-optional="true">
            <key-map field-name="partyId"/>
            <entity-condition>
                <date-filter/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="PCONEML" entity-name="org.apache.ofbiz.party.contact.PartyContactMechPurpose" join-from-alias="PCONTECH" join-optional="true">
            <key-map field-name="partyId"/>
            <key-map field-name="contactMechId"/>
            <entity-condition>
                <econdition field-name="contactMechPurposeTypeId" operator="equals" value="PRIMARY_EMAIL"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="CONEMIL" entity-name="org.apache.ofbiz.party.contact.ContactMech" join-from-alias="PCONEML" join-optional="true">
            <key-map field-name="contactMechId"/>
        </member-entity>
        <member-entity entity-alias="PCONPHON" entity-name="org.apache.ofbiz.party.contact.PartyContactMechPurpose" join-from-alias="PCONTECH" join-optional="true">
            <key-map field-name="partyId"/>
            <key-map field-name="contactMechId"/>
            <entity-condition>
                <econdition field-name="contactMechPurposeTypeId" operator="equals" value="PRIMARY_PHONE"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="CONTELE" entity-name="org.apache.ofbiz.party.contact.ContactMech" join-from-alias="PCONPHON" join-optional="true">
            <key-map field-name="contactMechId"/>
            <entity-condition>
                <econdition field-name="contactMechTypeId" entity-alias="CONTELE" operator="equals" value="TELECOM_NUMBER"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="TELECOM" entity-name="org.apache.ofbiz.party.contact.TelecomNumber" join-from-alias="CONTELE" join-optional="true">
            <key-map field-name="contactMechId"/>
        </member-entity>
        <entity-condition>
            <econdition field-name="partyId" entity-alias="NSPID" operator="is-null"/>
            <econdition field-name="roleTypeId" entity-alias="PROLE" operator="equals" value="CUSTOMER"/>
        </entity-condition>
        <alias name="HCCustomerId" field="partyId" entity-alias="PER"/>
        <alias name="firstName" entity-alias="PER"/>
        <alias name="lastName" entity-alias="PER"/>
        <alias name="HCShopifyCustomerId" field="idValue" entity-alias="PID"/>
        <alias name="email" field="infoString" function="max" entity-alias="CONEMIL"/>
        <alias name="countryCode" field="countryCode" function="max" entity-alias="TELECOM"/>
        <alias name="areaCode" field="areaCode" function="max" entity-alias="TELECOM"/>
        <alias name="contactNumber" field="contactNumber" function="max" entity-alias="TELECOM"/>
    </view-entity>
    <!-- This view is used for fetching the Fulfilled Order Item details.-->
    <view-entity entity-name="FulfilledOrderItemsSyncQueue" package="co.hotwax.netsuite.warehouse">
        <description>View to get details for the Order Item.</description>
        <member-entity entity-alias="OH" entity-name="org.apache.ofbiz.order.order.OrderHeader"/>
        <member-entity entity-alias="OI" entity-name="org.apache.ofbiz.order.order.OrderItem" join-from-alias="OH">
            <key-map field-name="orderId"/>
        </member-entity>
        <member-entity entity-alias="OIA" entity-name="org.apache.ofbiz.order.order.OrderItemAttribute" join-from-alias="OI">
            <key-map field-name="orderId"/>
            <key-map field-name="orderItemSeqId"/>
            <entity-condition>
                <econdition entity-alias="OIA" field-name="attrName" value="NetsuiteItemLineId"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="OA" entity-name="org.apache.ofbiz.order.order.OrderAttribute" join-from-alias="OI">
            <key-map field-name="orderId"/>
            <entity-condition>
                <econdition entity-alias="OA" field-name="attrName" value="NETSUITE_ORDER_EXPORTED"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="OISG" entity-name="org.apache.ofbiz.order.order.OrderItemShipGroup" join-from-alias="OI">
            <key-map field-name="orderId"/>
            <key-map field-name="shipGroupSeqId"/>
        </member-entity>
        <member-entity entity-alias="OFH" entity-name="co.hotwax.integration.order.OrderFulfillmentHistory" join-from-alias="OI" join-optional="true">
            <key-map field-name="orderId"/>
            <key-map field-name="orderItemSeqId"/>
        </member-entity>
        <member-entity entity-alias="OS" entity-name="org.apache.ofbiz.order.order.OrderStatus" join-from-alias="OI">
            <key-map field-name="orderId"/>
            <key-map field-name="orderItemSeqId"/>
            <key-map field-name="statusId"/>
        </member-entity>
        <member-entity entity-alias="F" entity-name="org.apache.ofbiz.product.facility.Facility" join-from-alias="OISG">
            <key-map field-name="facilityId"/>
        </member-entity>
        <member-entity entity-alias="FT" entity-name="org.apache.ofbiz.product.facility.FacilityType" join-from-alias="F">
            <key-map field-name="facilityTypeId"/>
        </member-entity>
        <member-entity entity-alias="FGM" entity-name="org.apache.ofbiz.product.facility.FacilityGroupMember" join-from-alias="F" join-optional="true">
            <key-map field-name="facilityId"/>
            <entity-condition>
                <date-filter/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="P" entity-name="org.apache.ofbiz.product.product.Product" join-from-alias="OI" join-optional="true">
            <key-map field-name="productId"/>
        </member-entity>
        <member-entity entity-alias="PT" entity-name="org.apache.ofbiz.product.product.ProductType" join-from-alias="P" join-optional="true">
            <key-map field-name="productTypeId"/>
        </member-entity>
        <member-entity entity-alias="SCENM" entity-name="moqui.basic.Enumeration" join-from-alias="OH" join-optional="true">
            <key-map field-name="salesChannelEnumId" related="enumId"/>
        </member-entity>
        <alias entity-alias="OH" name="productStoreId"/>
        <alias entity-alias="OIA" field="attrValue" name="netsuiteItemLineId"/>
        <alias entity-alias="OH" name="orderId"/>
        <alias entity-alias="OH" name="orderDate"/>
        <alias entity-alias="OH" name="orderTypeId"/>
        <alias entity-alias="OH" field="statusId" name="orderStatusId"/>
        <alias entity-alias="OH" name="entryDate"/>
        <alias entity-alias="OI" name="orderItemSeqId"/>
        <alias entity-alias="OI" field="statusId" name="itemStatusId"/>
        <alias entity-alias="OI"  name="quantity"/>
        <alias entity-alias="OI" field="externalId" name="orderItemExternalId"/>
        <alias entity-alias="OISG" name="shipGroupSeqId"/>
        <alias entity-alias="OISG" name="maySplit"/>
        <alias entity-alias="OISG" field="shipmentMethodTypeId" name="slaShipmentMethodTypeId"/>
        <alias entity-alias="OISG" field="contactMechId" name="postalContactMechId"/>
        <alias entity-alias="F" name="facilityId"/>
        <alias entity-alias="F" field="externalId" name="facilityExternalId"/>
        <alias entity-alias="FGM" name="facilityGroupId"/>
        <alias entity-alias="OS" name="statusDatetime" function="max"/>
        <alias entity-alias="P" name="productId"/>
        <alias entity-alias="PT" name="productTypeId"/>
        <alias entity-alias="PT" name="isPhysical"/>
        <alias entity-alias="PT" name="isDigital"/>
        <entity-condition>
            <econditions combine="and">
                <econdition entity-alias="OFH" field-name="orderId" operator="equals" value=""/>
                <econdition entity-alias="FGM" field-name="facilityGroupId" operator="equals" value="OMS_FULFILLMENT"/>
                <econdition entity-alias="OIA" field-name="attrValue" operator="not-equals" value=""/>
                <econdition entity-alias="OA" field-name="attrValue" operator="not-equals" value=""/>
                <econdition entity-alias="OISG" field-name="shipmentMethodTypeId" operator="not-equals" value="POS_COMPLETED"/>
            </econditions>
            <order-by field-name="entryDate"/>
        </entity-condition>
    </view-entity>

    <!-- View created for brokered order feed -->
    <view-entity entity-name="BrokeredOrderItemsFeed" package="co.hotwax.netsuite.warehouse">
        <description> View to get details for the brokered orders Items.</description>
        <member-entity entity-alias="OH" entity-name="org.apache.ofbiz.order.order.OrderHeader"/>
        <member-entity entity-alias="OI" entity-name="org.apache.ofbiz.order.order.OrderItem" join-from-alias="OH">
            <key-map field-name="orderId"/>
        </member-entity>
        <member-entity entity-alias="OIA" entity-name="org.apache.ofbiz.order.order.OrderItemAttribute" join-from-alias="OI">
            <key-map field-name="orderId"/>
            <key-map field-name="orderItemSeqId"/>
            <entity-condition>
                <econdition entity-alias="OIA" field-name="attrName" value="NetsuiteItemLineId"/>
            </entity-condition>
        </member-entity>
        <member-entity entity-alias="OISG" entity-name="org.apache.ofbiz.order.order.OrderItemShipGroup" join-from-alias="OI">
            <key-map field-name="orderId"/>
            <key-map field-name="shipGroupSeqId"/>
        </member-entity>
        <member-entity entity-alias="EFO" entity-name="co.hotwax.integration.order.ExternalFulfillmentOrderItem" join-from-alias="OI" join-optional="true">
            <key-map field-name="orderId"/>
            <key-map field-name="orderItemSeqId"/>
            <key-map field-name="shipGroupSeqId"/>
        </member-entity>
        <member-entity entity-alias="F" entity-name="org.apache.ofbiz.product.facility.Facility" join-from-alias="OISG">
            <key-map field-name="facilityId"/>
        </member-entity>
        <member-entity entity-alias="FT"  entity-name="org.apache.ofbiz.product.facility.FacilityType" join-from-alias="F">
            <key-map field-name="facilityTypeId"/>
        </member-entity>
        <member-entity entity-alias="FGM" entity-name="org.apache.ofbiz.product.facility.FacilityGroupMember" join-from-alias="F" join-optional="true">
            <key-map field-name="facilityId"/>
            <entity-condition>
                <date-filter/>
            </entity-condition>
        </member-entity>
        <alias entity-alias="OH" name="productStoreId"/>
        <alias entity-alias="OIA" field="attrValue" name="netsuiteItemLineId"/>
        <alias entity-alias="OH" field="orderId" name="orderId"/>
        <alias entity-alias="OI" field="orderItemSeqId" name="orderItemSeqId"/>
        <alias entity-alias="OI" field="quantity" name="orderItemQuantity"/>
        <alias entity-alias="OI" field="productId" name="productId"/>
        <alias entity-alias="OI" field="statusId" name="itemStatusId"/>
        <alias entity-alias="OISG" name="shipmentMethodTypeId"/>
        <alias entity-alias="OISG" field="shipGroupSeqId" name="shipGroupSeqId"/>
        <alias entity-alias="OH" name="entryDate"/>
        <alias entity-alias="F" field="externalId" name="facilityExternalId"/>
        <alias entity-alias="FGM" field="facilityGroupId" name="facilityGroupId"/>
        <alias entity-alias="OISG" field="contactMechId" name="postalContactMechId"/>
        <alias entity-alias="EFO" name="externalFulfillmentOrderItemId"/>
        <entity-condition>
            <econditions combine="and">
                <econdition entity-alias="OH" field-name="orderTypeId" operator="equals" value="SALES_ORDER"/>
                <econdition entity-alias="OIA" field-name="attrValue" operator="not-equals" value=""/>
                <econdition entity-alias="FT" field-name="parentTypeId" operator="not-equals" value="VIRTUAL_FACILITY"/>
                <econditions combine="or">
                    <econdition entity-alias="EFO" field-name="fulfillmentStatus" operator="equals" value="REJECT"/>
                    <econdition entity-alias="EFO" field-name="fulfillmentStatus" operator="equals" value=""/>
                </econditions>
            </econditions>
            <order-by field-name="entryDate"/>
        </entity-condition>
    </view-entity>
</entities>