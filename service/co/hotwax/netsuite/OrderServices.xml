<?xml version="1.0" encoding="UTF-8"?>
<services xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-definition-3.xsd">
    <service verb="generate" noun="NewOrdersSyncFeed" authenticate="anonymous-all" transaction-timeout="7200">
        <in-parameters>
            <parameter name="orderId">
                <description>Parameter to fetch Order details for a specific orderId.</description>
            </parameter>
            <parameter name="filePathPattern" required="true"/>
            <parameter name="systemMessageRemoteId" required="true">
                <description>The System Message Remote Id for generating the Orders Feed for Netsuite.</description>
            </parameter>
            <parameter name="fromOrderDate">
                <description>Parameter to fetch Order details after specific order date</description>
            </parameter>
            <parameter name="thruOrderDate">
                <description>Parameter to fetch Order details after specific order date</description>
            </parameter>
            <parameter name="includeShipmentMethod" type="List">
                <description>
                    Parameter to fetch Order details for specific shipment method or a list of shipping method
                    like: POS_COMPLETED,STORE_PICKUP
                </description>
            </parameter>
            <parameter name="excludeShipmentMethod" type="List">
                <description>Parameter to exclude the Orders from the specific shipment method or a list of shipping method
                    like: POS_COMPLETED,STORE_PICKUP
                </description>
            </parameter>
            <parameter name="includeSalesChannel" type="List">
                <description>Parameter to fetch Order details for specific sales channel or a list of sales channel.</description>
            </parameter>
            <parameter name="excludeSalesChannel" type="List">
                <description>Parameter to exclude the Orders from the specific sales channel or a list of sales channel.</description>
            </parameter>
            <parameter name="isMixCartOrder">
                <description>
                    Parameter to include or exclude the orders which have multiple shipping methods.
                    Example: Y to include the order with multiple shipping methods.
                    N to not include the order with multiple shipping methods.
                </description>
            </parameter>
            <parameter name="scriptPath">
                <description>
                    Path to the groovy script which will be used to generate the Feed File.
                </description>
            </parameter>
            <parameter name="ordersCountPerFeed" type="Integer" default-value="500"/>
            <parameter name="minAgeInMinutes" type="Integer">
                <description>
                    Minimum age (in minutes) the order should have spent in OMS before being included in the feed.
                    Example: 60 will include only orders where entryDate is at least 60 minutes old.
                </description>
            </parameter>
        </in-parameters>
        <actions>
            <set field="nowTimestamp" from="ec.user.nowTimestamp"/>
            <log message="Generating Order Feed file for Order ${orderId} at time ${nowTimestamp}"/>
            <script>
                import java.nio.file.Files
                import java.nio.file.Paths
                import java.nio.charset.StandardCharsets
                import org.moqui.entity.EntityCondition
                import co.hotwax.netsuite.NetSuiteMappingWorker
                import co.hotwax.ns.util.CsvWriteHelper
                import co.hotwax.ns.util.PhoneValidationUtil

                findNetSuiteOrders = ec.entity.find("co.hotwax.netsuite.order.EligibleOrders")
                if(orderId) findNetSuiteOrders.condition("orderId", orderId)
                if(fromOrderDate) findNetSuiteOrders.condition("orderDate", EntityCondition.ComparisonOperator.GREATER_THAN, fromOrderDate)
                if(thruOrderDate) findNetSuiteOrders.condition("orderDate", EntityCondition.ComparisonOperator.LESS_THAN, thruOrderDate)
                if(includeShipmentMethod) findNetSuiteOrders.condition("shipmentMethodTypeId",EntityCondition.ComparisonOperator.IN, includeShipmentMethod)
                if(excludeShipmentMethod) findNetSuiteOrders.condition("shipmentMethodTypeId",EntityCondition.ComparisonOperator.NOT_IN, excludeShipmentMethod)
                if(includeSalesChannel) findNetSuiteOrders.condition("salesChannelEnumId",EntityCondition.ComparisonOperator.IN, includeSalesChannel)
                if(excludeSalesChannel) findNetSuiteOrders.condition("salesChannelEnumId",EntityCondition.ComparisonOperator.NOT_IN, excludeSalesChannel)
                if(isMixCartOrder) findNetSuiteOrders.condition("isMixCartOrder", isMixCartOrder)

                if (minAgeInMinutes) {
                    Calendar ageCal = ec.user.getNowCalendar()
                    ageCal.add(Calendar.MINUTE, -minAgeInMinutes.toInteger())
                    Timestamp maxEntryDate = new Timestamp(ageCal.getTimeInMillis())
                    findNetSuiteOrders.condition("entryDate", EntityCondition.ComparisonOperator.LESS_THAN_EQUAL_TO, maxEntryDate)
                }

                findNetSuiteOrders.selectField("orderId,partyId,netsuiteCustomerId,orderDate,isMixCartOrder,shopifyOrderId")
                findNetSuiteOrders.useClone(true)
                findNetSuiteOrders.distinct(true)
                findNetSuiteOrders.limit(ordersCountPerFeed)

                //If no eligible orders, then don't generate the file
                long netsuiteOrdersCount = findNetSuiteOrders.count()
                if (netsuiteOrdersCount == 0) {
                    ec.message.addMessage("No eligible orders at ${nowTimestamp}, not generating the HotWax Feed file for Netsuite.")
                    return
                }
            </script>

            <set field="csvFilePathRef" value="runtime://datamanager/${filePathPattern}/CreateOrderItemsFeed_${ec.l10n.format(nowTimestamp, 'yyyy-MM-dd-HH-mm-ss')}.csv"/>
            <set field="invalidFilePathRef" value="runtime://datamanager/${filePathPattern}/required_fields_missing/CreateOrderItemsFeed_${ec.l10n.format(nowTimestamp, 'yyyy-MM-dd-HH-mm-ss')}.csv"/>
            <set field="csvFilePath" from="ec.resource.getLocationReference(csvFilePathRef).getUri().getPath()"/>
            <set field="invalidFilePath" from="ec.resource.getLocationReference(invalidFilePathRef).getUri().getPath()"/>

            <set field="sendPath" from="'/home/${sftpUsername}/' + filePathPattern + '/'"/>
            <set field="invalidSendPath" from="'/home/${sftpUsername}/' + filePathPattern + '/required_fields_missing/'"/>

            <set field="isFileEmpty" from="true"/>
            <set field="isReqFieldMissFileEmpty" from="true"/>
            <set field="csvHeaders" from="null"/>

            <script>
                // Using try-with-resources to automatically close the EntityListIterator 'ordersItr'
                try (ordersItr = findNetSuiteOrders.iterator(); CsvWriteHelper validFileCsvHelper = new CsvWriteHelper(csvFilePath, null, 0); CsvWriteHelper invalidFileCsvHelper = new CsvWriteHelper(invalidFilePath, null, 0)) {
            </script>

            <iterate list="ordersItr" entry="order">
                <set field="orderDetails" from="[:]"/>
                <script> orderMaster = ec.entity.find("org.apache.ofbiz.order.order.OrderHeader").condition("orderId", order.orderId).oneMaster()</script>

                <!-- Calculate shipping cost from SHIPPING_CHARGES adjustments in orderMaster -->
                <set field="shippingAdjustments" from="orderMaster.get('adjustments')?.findAll{ it.orderAdjustmentTypeId == 'SHIPPING_CHARGES' }"/>
                <set field="totalShippingCost" from="shippingAdjustments ? shippingAdjustments.sum{ it.amount ?: BigDecimal.ZERO } : BigDecimal.ZERO"/>
                <set field="orderDetails.shippingCost" from="totalShippingCost"/>
                <set field="orderDetails.date" from="ec.l10n.format(orderMaster.orderDate, 'MM/dd/yyyy')"/>
                <set field="orderDetails.HCShopifySalesOrderId" from="orderMaster.identifications?.find{ it.orderIdentificationTypeId == 'SHOPIFY_ORD_ID' }?.idValue"/>

                <!-- Extract phone numbers from contact mechs -->
                <set field="billingPhone" from="orderMaster.contactMechs?.find { it.contactMechPurposeTypeId == 'PHONE_BILLING' }?.telecomNumber"/>
                <set field="shippingPhone" from="orderMaster.contactMechs?.find { it.contactMechPurposeTypeId == 'PHONE_SHIPPING' }?.telecomNumber"/>

                <!-- Format billing phone if valid -->
                <if condition="billingPhone">
                    <set field="billingValid" from="PhoneValidationUtil.isValidPhoneNumber(billingPhone.countryCode, billingPhone.areaCode, billingPhone.contactNumber, ec)"/>
                    <if condition="billingValid">
                        <set field="formattedBillingPhone" from="PhoneValidationUtil.getFormattedPhoneNumber(billingPhone.countryCode, billingPhone.areaCode, billingPhone.contactNumber)"/>
                        <set field="orderDetails.billingPhone" from="formattedBillingPhone"/>
                    </if>
                </if>
                <set field="orderDetails.billingPhone" from="orderDetails.billingPhone ?: ''"/>

                <!-- Format shipping phone if valid -->
                <if condition="shippingPhone">
                    <set field="shippingValid" from="PhoneValidationUtil.isValidPhoneNumber(shippingPhone.countryCode, shippingPhone.areaCode, shippingPhone.contactNumber, ec)"/>
                    <if condition="shippingValid">
                        <set field="formattedShippingPhone" from="PhoneValidationUtil.getFormattedPhoneNumber(shippingPhone.countryCode, shippingPhone.areaCode, shippingPhone.contactNumber)"/>
                        <set field="orderDetails.phone" from="formattedShippingPhone"/>
                    </if>
                </if>
                <set field="orderDetails.phone" from="orderDetails.phone ?: ''"/>

                <set field="billingContact" from="orderMaster.contactMechs?.find { it.contactMechPurposeTypeId == 'BILLING_LOCATION' }"/>
                <set field="shippingContact" from="orderMaster.contactMechs?.find { it.contactMechPurposeTypeId == 'SHIPPING_LOCATION' }"/>

                <set field="billingAddress" from="billingContact?.postalAddress"/>
                <set field="shippingAddress" from="shippingContact?.postalAddress"/>

                <set field="orderDetails" from="orderDetails + [
                    billingAddress1:'', billingAddress2:'', billingCity:'', billingState:'', billingCountry:'', billingZip:'', billingAddressee:'',
                    address1:'', address2:'', city:'', state:'', country:'', zip:'', addressee:''
                ]"/>

                <if condition="billingAddress">
                    <set field="orderDetails.billingAddress1" from="billingAddress.address1 ?: ''"/>
                    <set field="orderDetails.billingAddress2" from="billingAddress.address2 ?: ''"/>
                    <set field="orderDetails.billingCity" from="billingAddress.city ?: ''"/>
                    <set field="orderDetails.billingState" from="billingAddress.stateProvinceGeoId ?: ''"/>
                    <set field="orderDetails.billingCountry" from="billingAddress.countryGeoId ?: ''"/>
                    <set field="orderDetails.billingZip" from="billingAddress.postalCode ?: ''"/>
                    <set field="orderDetails.billingAddressee" from="billingAddress.toName ?: ''"/>
                </if>

                <!-- Shipping Address -->
                <if condition="shippingAddress">
                    <set field="orderDetails.shippingContactMechId" from="shippingContact.contactMechId"/>
                    <set field="orderDetails.address1" from="shippingAddress.address1 ?: ''"/>
                    <set field="orderDetails.address2" from="shippingAddress.address2 ?: ''"/>
                    <set field="orderDetails.city" from="shippingAddress.city ?: ''"/>
                    <set field="orderDetails.state" from="shippingAddress.stateProvinceGeoId ?: ''"/>
                    <set field="orderDetails.country" from="shippingAddress.countryGeoId ?: ''"/>
                    <set field="orderDetails.zip" from="shippingAddress.postalCode ?: ''"/>
                    <set field="orderDetails.addressee" from="shippingAddress.toName ?: ''"/>
                </if>

                <!-- Fallback Logic: If billing is missing but shipping is present â†’ copy shipping to billing -->
                <if condition="!billingAddress &amp;&amp; shippingAddress">
                    <set field="orderDetails.billingContactMechId" from="orderDetails.shippingContactMechId"/>
                    <set field="orderDetails.billingAddress1" from="orderDetails.address1"/>
                    <set field="orderDetails.billingAddress2" from="orderDetails.address2"/>
                    <set field="orderDetails.billingCity" from="orderDetails.city"/>
                    <set field="orderDetails.billingState" from="orderDetails.state"/>
                    <set field="orderDetails.billingCountry" from="orderDetails.country"/>
                    <set field="orderDetails.billingZip" from="orderDetails.zip"/>
                    <set field="orderDetails.billingAddressee" from="orderDetails.addressee"/>
                </if>

                <!-- Extract billing and shipping emails from contactMechs -->
                <set field="orderDetails.billingEmail" from="orderMaster.contactMechs.find{ it.contactMechPurposeTypeId == 'BILLING_EMAILn' }?.contactMech?.infoString ?: ''"/>

                <set field="orderDetails.email" from="orderMaster.contactMechs.find{ it.contactMechPurposeTypeId == 'SHIPPING_EMAIL' }?.contactMech?.infoString ?: ''"/>


                <entity-find entity-name="org.apache.ofbiz.party.party.PartyIdentification" list="partyIdentificationList">
                    <econdition field-name="partyIdentificationTypeId" value="NETSUITE_CUSTOMER_ID"/>
                    <econdition field-name="partyId" from="orderMaster.roles.find{ it.roleTypeId == 'BILL_TO_CUSTOMER' }?.partyId"/>
                </entity-find>

                <set field="orderDetails.customer" from="partyIdentificationList?.first?.idValue"/>

                <entity-find-one entity-name="org.apache.ofbiz.product.store.ProductStore" value-field="productStore" cache="true">
                    <field-map field-name="productStoreId" from="orderMaster.productStoreId"/>
                </entity-find-one>

                <entity-find-one entity-name="moqui.basic.Enumeration" cache="true" value-field="orderSalesChannel">
                    <field-map field-name="enumId" from="orderMaster.salesChannelEnumId"/>
                </entity-find-one>


                <set field="orderDetails.shippingTaxCode" from="NetSuiteMappingWorker.getShippingTaxCode(ec, order.orderId)"/>
                <!-- Scenario of Exchange Order Gift Card Payment -->
                <set field="orderDetails.giftCardPaymentTotal" from="NetSuiteMappingWorker.getExchOrderGiftCardPaymentTotal(ec, order.orderId)"/>
                <!-- Scenario of Original Order Gift Card Payment -->
                <if condition="!orderDetails.giftCardPaymentTotal">
                    <set field="orderDetails.giftCardPaymentTotal" from="NetSuiteMappingWorker.getGiftCardPaymentTotal(ec, order.orderId)"/>
                </if>

                <set field="itemAmountTotal" from="orderMaster.shipGroups*.items.flatten().sum{ (it.price ?: BigDecimal.ZERO) * (it.quantity ?: BigDecimal.ZERO) }" type="BigDecimal"/>
                <set field="totalAdjustment" from="orderMaster.adjustments?.sum{ it.amount ?: BigDecimal.ZERO }" type="BigDecimal"/>
                <set field="grandTotal" from="(totalAdjustment ?: BigDecimal.ZERO) + (itemAmountTotal ?: BigDecimal.ZERO)" type="BigDecimal"/>

                <set field="orderDetails" from="orderDetails + [orderId:orderMaster.orderName, HCOrderId:orderMaster.orderId, subsidiary:productStore.externalId,
                    salesChannel:orderSalesChannel.description, salesChannelEnumId:orderMaster.salesChannelEnumId, externalId: orderMaster.externalId]"/>

                <set field="orderItems" from="[]"/>
                <set field="shipmentMethodTypeList" from="[]"/>
                <iterate list="orderMaster.shipGroups" entry="shipGroup">
                    <script>shipmentMethodTypeList.add(shipGroup.shipmentMethodTypeId)</script>

                    <iterate list="shipGroup.items" entry="orderItem">
                        <set field="orderItemMap" from="[:]"/>

                        <set field="orderItemMap.orderLineId" from="orderItem.orderItemSeqId"/>
                        <set field="orderItemMap.taxCode" from="NetSuiteMappingWorker.getTaxCode(ec, order.orderId, orderItem.orderItemSeqId)"/>
                        <set field="orderItemMap.closed" from="'ITEM_CANCELLED'.equalsIgnoreCase(orderItem.statusId)"/>
                        <set field="orderItemMap.priceLevel" from="NetSuiteMappingWorker.getIntegrationTypeMappingValue(ec, 'NETSUITE_PRICE_LEVEL', 'PRICE_LEVEL')" type="String"/>
                        <set field="orderItemMap.department" from="NetSuiteMappingWorker.getFacilityIdentifications(ec, orderItem.orderFacilityId, 'ORDR_ORGN_DPT')" type="String"/>


                        <set field="facilityId" from="orderItem.facilityId"/>
                        <set field="orderFacilityId" from="orderItem.orderFacilityId"/>

                        <entity-find entity-name="co.hotwax.facility.FacilityGroupAndMember" list="facilityGroupInfoList">
                            <econdition field-name="facilityId" from="facilityId"/>
                            <econdition field-name="facilityGroupId" value="NETSUITE_FULFILLMENT"/>
                            <econdition field-name="parentFacilityTypeId" operator="not-equals" value="VIRTUAL_FACILITY"/>
                        </entity-find>

                        <entity-find entity-name="co.hotwax.facility.FacilityGroupAndMember" list="orderFacilityInfoList">
                            <econdition field-name="facilityId" from="orderFacilityId"/>
                            <econdition field-name="parentFacilityTypeId" operator="not-equals" value="VIRTUAL_FACILITY"/>
                        </entity-find>

                        <set field="itemLoc" value=""/>
                        <if condition="(facilityGroupInfoList &amp;&amp; !facilityGroupInfoList.isEmpty())">
                            <set field="itemLoc" from="facilityGroupInfoList.first()?.externalId ?: ''"/>
                        </if>
                        <set field="orderItemMap.itemLocation" from="itemLoc"/>

                        <set field="orderLoc" value=""/>
                        <if condition="orderFacilityInfoList &amp;&amp; !orderFacilityInfoList.isEmpty()">
                            <set field="orderLoc" from="orderFacilityInfoList.first()?.externalId ?: ''"/>
                        </if>
                        <set field="orderItemMap.location" from="orderLoc"/>


                        <entity-find-one entity-name="org.apache.ofbiz.product.product.GoodIdentification" value-field="netsuiteProductId">
                            <field-map field-name="goodIdentificationTypeId" value="NETSUITE_PRODUCT_ID"/>
                            <field-map field-name="productId" from="orderItem.productId"/>
                        </entity-find-one>
                        <set field="orderItemMap.item" from="netsuiteProductId?.idValue"/>
                        <set field="orderItemMap" from="orderItemMap + [price:orderItem.price, quantity:orderItem.quantity]"/>

                        <script>orderItems.add(orderItemMap)</script>

                        <set field="discountItems" from="NetSuiteMappingWorker.getDiscountItem(ec, order.orderId, orderItem)"/>
                        <if condition="discountItems"><script>orderItems.addAll(discountItems)</script></if>
                    </iterate>
                </iterate>
                <set field="orderDetails.shippingMethod" from="NetSuiteMappingWorker.getShippingMethod(ec, order.isMixCartOrder, shipmentMethodTypeList)"/>

                <set field="orderDetails" from="orderDetails + [HCOrderTotal:grandTotal, orderItems:orderItems]"/>
                <set field="requiredFields" from="['date', 'country', 'customer']"/>
                <if condition="scriptPath">
                    <set field="scriptResult" from="ec.resource.script(scriptPath, null)"/>
                    <set field="orderDetails" from="scriptResult.orderData"/>
                    <set field="requiredFields" from="requiredFields + scriptResult.customRequiredFileds"/>
                </if>
                <set field="netsuiteOrderItemList" from="NetSuiteMappingWorker.prepareNetSuiteOrderItemList(orderDetails)"/>
                <script>
                    // Check for required fields and separate valid/invalid orders
                    netsuiteOrderItemList.each { record ->
                        def missingFields = requiredFields.findAll { !record[it] || record[it].toString().trim() == '' }

                        if (missingFields) {
                            record.put("Missing Required Fields", missingFields.join(', '))
                            invalidFileCsvHelper.writeToFile(record)
                            isReqFieldMissFileEmpty = false
                        } else {
                            validFileCsvHelper.writeToFile(record)
                            isFileEmpty = false
                        }
                    }
                    orderDetails = null
                </script>
            </iterate>
            <set field="generatedCsvFilePath" from="validFileCsvHelper.getGeneratedFilePaths()"/>
            <set field="generatedInvalidCsvFilePath" from="invalidFileCsvHelper.getGeneratedFilePaths()"/>
            <script>
                }
            </script>
            <if condition="!isFileEmpty">
                <service-call name="co.hotwax.helper.HelperServices.put#FileOnSftp"
                    in-map="[systemMessageRemoteId:systemMessageRemoteId, receivePath:csvFilePath, sendPath:sendPath]"/>
            </if>
            <if condition="!isReqFieldMissFileEmpty">
                <service-call name="co.hotwax.helper.HelperServices.put#FileOnSftp"
                    in-map="[systemMessageRemoteId:systemMessageRemoteId, receivePath:invalidFilePath, sendPath:invalidSendPath]"/>
            </if>
            <return message="Generated Order Items Feed file  ${generatedCsvFilePath} and missing file response in ${generatedInvalidCsvFilePath}"/>
        </actions>
    </service>
    <service verb="generate" noun="FulfilledOrderItemsFeed" authenticate="anonymous-all" transaction-timeout="7200">
        <in-parameters>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="fulfilledOrdersCountPerFeed" type="Integer" default-value="2500"/>
            <parameter name="orderId"/>
            <parameter name="orderItemSeqId"/>
        </in-parameters>
        <actions>
            <set field="nowTimestamp" from="ec.user.nowTimestamp"/>
            <set field="baseFile" value="runtime://datamanager/netsuite/FulfillmentFeed/fulfilledOrderItemsFeed_${ec.l10n.format(nowTimestamp, 'yyyy-MM-dd-HH-mm-ss')}.csv"/>
            <set field="baseFilePath" from="ec.resource.getLocationReference(baseFile).getUri().getPath()"/>
            <set field="sendPath" from="'/home/${sftpUsername}/netsuite/salesorder/update/'"/>
            <set field="headers" from="['lineId', 'internalId', 'item', 'quantity', 'location', 'tags']"/>
            <script>
                fulfilledOrderItemsFind = ec.entity.find("co.hotwax.netsuite.warehouse.FulfilledOrderItems")
                if(orderId) fulfilledOrderItemsFind.condition("orderId", orderId)
                if(orderItemSeqId) fulfilledOrderItemsFind.condition("orderItemSeqId", orderItemSeqId)

                //If no eligible orders, then don't generate the file
                long netsuiteOrdersCount = fulfilledOrderItemsFind.count()
                if (netsuiteOrdersCount == 0) {
                    ec.message.addMessage("No eligible orders for Fulfilled Order and Items Feed at ${nowTimestamp}, not generating the HotWax Feed file.")
                    return
                }

                import co.hotwax.ns.util.CsvWriteHelper
                try (fulfilledOrderItemsItr = fulfilledOrderItemsFind.iterator();
                    CsvWriteHelper CsvWriteHelper = new CsvWriteHelper(baseFilePath, headers, fulfilledOrdersCountPerFeed)) {
            </script>
            <iterate list="fulfilledOrderItemsItr" entry="fulfilledOrderItem">
                <set field="fulfilledOrderItemMap" from="[
                    lineId:fulfilledOrderItem.netsuiteItemLineId,
                    internalId:fulfilledOrderItem.netsuiteOrderId,
                    item:'',
                    quantity:fulfilledOrderItem.quantity,
                    location:fulfilledOrderItem.facilityExternalId,
                    tags:'hotwax-fulfilled'
                ]"/>
                <script>CsvWriteHelper.writeToFile(fulfilledOrderItemMap)</script>
                <service-call name="create#co.hotwax.integration.order.OrderFulfillmentHistory" in-map="[orderId:fulfilledOrderItem.orderId,
                    orderItemSeqId:fulfilledOrderItem.orderItemSeqId, comments:'Order Item sent as part of OMS to NetSuite Fulfilled Items Feed', createdDate:nowTimestamp, externalFulfillmentId:'_NA_']"/>
            </iterate>
            <entity-find-one entity-name="moqui.service.message.SystemMessageRemote" value-field="systemMessageRemote"/>
            <set field="generatedFilePaths" from="CsvWriteHelper.getGeneratedFilePaths()"/>
            <script>}</script>
            <iterate list="generatedFilePaths" entry="generatedFilePath">
                <service-call name="co.hotwax.helper.HelperServices.put#FileOnSftp" in-map="[systemMessageRemoteId:systemMessageRemote.systemMessageRemoteId, receivePath:generatedFilePath, sendPath:sendPath]"/>
            </iterate>
            <return message=" Created the Fulfilled Order Items Feed file with orders count ${netsuiteOrdersCount} at time ${nowTimestamp} saved response in messages ${generatedFilePaths}"/>
        </actions>
    </service>
    <service verb="generate" noun="NetsuiteBrokeredOrderItemsFeed" authenticate="anonymous-all" transaction-timeout="7200">
        <description>
            Service to generate Brokered Order Items Feed for the new order sync flow with added check for NetsuiteItemLineId and takes count per feed which can take in a limit parameter
            to include a specific number of records in the Feed File.
            If no limit is set, default-value of limit parameter will be considered to fetch the
            eligible orders for the feed.
        </description>
        <in-parameters>
            <parameter name="brokeredOrdersCountPerFeed" type="Integer" default-value="0"/>
            <parameter name="orderId"/>
            <parameter name="orderItemSeqId"/>
            <parameter name="filePathPattern" required="true"/>
            <parameter name="systemMessageRemoteId" required="true"/>
            <parameter name="templatePath" default-value="component://mantle-netsuite-connector/template/GetBrokeredOrderItemsDetail.ftl">
                <description>
                    Path to the ftl template which will be used to generate the Feed File.
                </description>
            </parameter>
        </in-parameters>
        <actions>

            <set field="nowTimestamp" from="ec.user.nowTimestamp"/>
            <set field="baseFile" value="runtime://datamanager/${filePathPattern}/brokeredOrderItemsFeed_${ec.l10n.format(nowTimestamp, 'yyyy-MM-dd-HH-mm-ss')}.csv"/>
            <set field="baseFilePath" from="ec.resource.getLocationReference(baseFile).getUri().getPath()"/>
            <set field="sendPath" from="'/home/${sftpUsername}/' + filePathPattern + '/'"/>
            <script>
                import groovy.json.JsonSlurper
                import co.hotwax.ns.util.CsvWriteHelper
                import org.moqui.entity.EntityCondition

                brokeredOrderItemFind = ec.entity.find("co.hotwax.netsuite.warehouse.NetsuiteBrokeredOrderItemsFeed").distinct(true)
                if(orderId) brokeredOrderItemFind.condition("orderId", orderId)
                if(orderItemSeqId) brokeredOrderItemFind.condition("orderItemSeqId", orderItemSeqId)
                    .selectField("orderId,netsuiteOrderId,entryDate,netsuiteItemLineId,orderItemSeqId,productStoreId,productId,shipmentMethodTypeId,facilityExternalId,postalContactMechId,itemStatusId,externalFulfillmentOrderItemId,shipGroupSeqId,orderItemQuantity")
                    .orderBy("entryDate")

                //If no eligible orders, then don't generate the file
                long netsuiteBrokeredOrdersCount = brokeredOrderItemFind.count()
                if (netsuiteBrokeredOrdersCount == 0) {
                    ec.message.addMessage("No eligible orders for Brokered Order and Items Feed at ${nowTimestamp}, not generating the HotWax Feed file.")
                    return
                }

                try (brokeredOrderItemsItr = brokeredOrderItemFind.iterator();
                CsvWriteHelper CsvWriteHelper = new CsvWriteHelper(baseFilePath, null, brokeredOrdersCountPerFeed)) {
            </script>
            <set field="jsonSlurper" from="new groovy.json.JsonSlurper()"/>
            <iterate list="brokeredOrderItemsItr" entry="brokerOrderItem">
                <set field="templateWriter" from="new StringWriter()"/>
                <script>ec.resourceFacade.template(templatePath, templateWriter)</script>
                <set field="templateWriter" from="templateWriter.toString()"/>
                <set field="brokerOrderItemList" from="jsonSlurper.parseText(templateWriter)" type="List"/>
                <iterate list="brokerOrderItemList" entry="brokerOrderItemMap">
                    <script>CsvWriteHelper.writeToFile(brokerOrderItemMap)</script>
                </iterate>
                <if condition="brokerOrderItem.externalFulfillmentOrderItemId"><then>
                    <service-call name="update#co.hotwax.integration.order.ExternalFulfillmentOrderItem"
                        in-map="[externalFulfillmentOrderItemId:brokerOrderItem.externalFulfillmentOrderItemId,
                        fulfillmentStatus:'Sent']"/>
                </then><else>
                    <service-call name="create#co.hotwax.integration.order.ExternalFulfillmentOrderItem" in-map="[orderId:brokerOrderItem.orderId,
                        orderItemSeqId:brokerOrderItem.orderItemSeqId, shipGroupSeqId:brokerOrderItem.shipGroupSeqId,
                        fulfillmentStatus:'Sent', createdDate:nowTimestamp, quantity:brokerOrderItem.orderItemQuantity]"/>
                </else></if>
            </iterate>
            <entity-find-one entity-name="moqui.service.message.SystemMessageRemote" value-field="systemMessageRemote"/>
            <set field="generatedFilePaths" from="CsvWriteHelper.getGeneratedFilePaths()"/>
            <script>}</script>
            <iterate list="generatedFilePaths" entry="generatedFilePath">
                <service-call name="co.hotwax.helper.HelperServices.put#FileOnSftp" in-map="[systemMessageRemoteId:systemMessageRemote.systemMessageRemoteId, receivePath:generatedFilePath, sendPath:sendPath]"/>
            </iterate>
            <return message=" Created the Brokered Order Items Feed file at time ${nowTimestamp} saved response in path ${generatedFilePaths}"/>
        </actions>
    </service>
</services>